<!DOCTYPE html>
<!--
SEEK
Copyright (C) 2025 placelink

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program. If not, see <https://www.gnu.org/licenses/>.

=========================================================================

상업적 이용 또는 AGPL-3.0의 공개 의무를 면제받기
위해서는, placelink로부터 별도의 상업용 라이선스(Commercial License)를 구매해야 합니다.
For commercial use or to obtain an exemption from the AGPL-3.0 license
requirements, please purchase a commercial license from placelink.
*** 문의처: help@placelink.shop (README.md 참조)
-->
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{_layout/basic/layout}">
    <th:block layout:fragment="bodyStyle"></th:block>
    <th:block layout:fragment="bodyScript">
        <script type="module">
            import {S2Util} from '[[@{/public/js/s2.util.js}]]';
            import {S2DropZone} from '[[@{/public/js/s2.dropzone.js}]]';

            window.initPage = () => {
                document.querySelector('.btn-open-validate-file')?.addEventListener('click', openValidateFile);
                document.querySelectorAll('.btn-coming-soon')?.forEach((btn) => btn.addEventListener('click', () => S2Util.alert('준비 중입니다.')));
                document.querySelectorAll('.btn-download-signed-file')?.forEach((btn) => btn.addEventListener('click', (event) => downloadFile(event.currentTarget.dataset.signedFileId)));
            };

            window.goPage = (pageNo) => {
                location.href = `/public/analysis/detection-file?pageNo=${pageNo}`;
            };

            let isRegistering = false;

            function openValidateFile() {
                S2Util.showModal(
                    `
                        <div class="risk-inspection-wrap modal">
                            <div class="tab-container">
                                <div>
                                    <div id="tab-file" class="tab-contents active">
                                        <div class="contents file-upload">
                                            <div class="file-upload-box">
                                                <input type="file" class="file-upload d-none" multiple accept=".pdf, .hwpx, .docx, .xlsx, .pptx"/>
                                                <div class="file-upload-icon">
                                                    <img src="/public/images/file_upload_icon.png" alt="파일아이콘"/>
                                                </div>
                                                <ul class="upload-file-list">
                                                </ul>
                                                <div class="file-upload-text">
                                                    <p>첨부할 파일을 여기에 끌어다 놓거나, 파일 선택 버튼을 직접 선택해주세요.</p>
                                                </div>
                                                <button class="file-upload-button">파일선택</button>
                                            </div>
                                        </div>
                                        <div class="button-wrap c-ma-t30">
                                            <button class="btn-sty-01 create-article-btn">등록</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `,
                    {
                        width: '800px',
                        title: '파일 검증'
                    },
                    function (modalSelector) {
                        initDropZone();

                        // 파일 검증 등록 버튼 클릭 이벤트 처리
                        document.querySelector('.risk-inspection-wrap.modal .create-article-btn')?.addEventListener('click', () => {
                            if (!isRegistering) {
                                isRegistering = true;

                                if (g_uploadFiles.length === 0) {
                                    S2Util.alert('파일이 없습니다.');
                                    isRegistering = false;
                                    return;
                                }

                                // 파일 등록
                                S2Util.fetch(
                                    '/analysis/create-detection-file',
                                    {
                                        method: 'post',
                                        dataType: 'multipart/form-data',
                                        files: g_uploadFiles
                                    },
                                    function () {
                                        S2Util.hideModal(modalSelector);
                                        S2Util.showToast('등록되었습니다.');
                                        setTimeout(function () {
                                            location.reload();
                                        }, 1000);
                                    },
                                    function () {
                                        isRegistering = false;
                                    }
                                );
                            }
                        });
                    }
                );
            }

            function downloadFile(fileId) {
                S2Util.fetch(
                    `/file/download/${fileId}`,
                    {
                        method: 'GET',
                        responseType: 'blob'
                    },
                    function () {
                        S2Util.showToast('다운로드 성공하였습니다.');
                    }
                );
            }

            let g_uploadFiles = [];

            function checkFileExtension(fileList) {
                let result = true;
                const allowedExtensions = ['pdf', 'hwpx', 'docx', 'xlsx', 'pptx'];
                for (let file of fileList) {
                    const ext = file.name.split('.').pop().toLowerCase();
                    if (!allowedExtensions.includes(ext)) {
                        S2Util.alert('허용되지 않은 파일 형식입니다: ' + file.name);
                        result = false;
                        break;
                    }
                }
                return result;
            }

            /**
             * 업로드 파일 추가 UI
             * @param {FileList} fileList - 파일 목록
             */
            function addUploadFileUI(fileList) {
                const uploadFileList = document.querySelector('.upload-file-list');

                if (fileList.length > 0) {
                    document.querySelector('.file-upload .file-upload-box').classList.add('active');
                    document.querySelector('.file-upload .file-upload-icon').classList.add('d-none');

                    // DocumentFragment를 사용하여 DOM 조작 최소화
                    const fragment = document.createDocumentFragment();

                    for (const file of fileList) {
                        const listItem = document.createElement('li');
                        listItem.className = 'file-upload-ok';

                        listItem.innerHTML = `
                            <img class="checked-file" src="/public/images/icon_file_chk.png" alt="파일선택완료"/>
                            <div class="file-info">
                                <div class="c-flex-sty02">
                                    <div class="file-border"></div>
                                    <div class="file-title file-name">${file.name}</div>
                                </div>
                                <div class="file-remove">
                                    <a href="#" class="btn-remove-selected-file"><img src="/public/images/icon_remove.png" alt="삭제아이콘"/></a>
                                </div>
                            </div>
                        `;

                        listItem.querySelector('.btn-remove-selected-file')?.addEventListener('click', (e) => {
                            e.preventDefault();
                            removeSelectedFile(e.currentTarget);
                        });

                        fragment.appendChild(listItem);
                    }

                    //  최종적으로 DOM을 한 번만 업데이트
                    uploadFileList.appendChild(fragment);
                }
            }

            function initDropZone() {
                g_uploadFiles = [];
                const dropZone = document.querySelector('.file-upload .file-upload-box');
                const fileUpload = document.querySelector('.file-upload .file-upload');

                new S2DropZone({
                    dropZone: dropZone,
                    dragenter: function (event, dropZoneElement) {
                        dropZoneElement.classList.add('highlight');
                    },
                    dragover: function (event, dropZoneElement) {
                        dropZoneElement.classList.add('highlight');
                    },
                    dragleave: function (event, dropZoneElement) {
                        dropZoneElement.classList.remove('highlight');
                    },
                    drop: function (event, dropZoneElement, dropFiles) {
                        dropZoneElement.classList.remove('highlight');

                        if (dropFiles.length > 0 && checkFileExtension(dropFiles)) {
                            for (const file of dropFiles) {
                                g_uploadFiles.push(file);
                            }
                            addUploadFileUI(dropFiles);
                        }
                    }
                });

                // 파일 선택 버튼 클릭 이벤트
                const fileUploadButton = dropZone.querySelector('.file-upload-button');
                if (fileUploadButton) {
                    fileUploadButton.addEventListener('click', () => fileUpload.click());
                }

                // 파일 선택 이벤트
                if (fileUpload) {
                    fileUpload.addEventListener('change', () => {
                        if (fileUpload.files.length > 0 && checkFileExtension(fileUpload.files)) {
                            for (const file of fileUpload.files) {
                                g_uploadFiles.push(file);
                            }
                            addUploadFileUI(fileUpload.files);
                        }
                    });
                }
            }

            /**
             * 선택한 파일 제거
             */
            function removeSelectedFile(target) {
                const delElement = target.closest('li');

                const parentUl = delElement.parentElement;
                const allLiElements = Array.from(parentUl.children);
                const delIndex = allLiElements.indexOf(delElement);

                g_uploadFiles.splice(delIndex, 1);
                delElement.remove();

                if (g_uploadFiles.length === 0) {
                    document.querySelector('.file-upload .file-upload-box').classList.remove('active');
                    document.querySelector('.file-upload .file-upload-icon').classList.remove('d-none');
                }
            }
        </script>
    </th:block>
    <th:block layout:fragment="bodyFragment">
        <div class="main-contents-contents">
            <div class="wrap-top">
                <h1>
                    <span class="main-title menu2">디지털 서명 현황</span>
                    <span class="sub-title">민감정보 탐지 현황 및 서명 파일 다운로드</span>
                </h1>
                <span class="btn-group">
                    <button class="btn-type1 btn-open-validate-file">파일 검증</button>
                    <button class="btn-type1 btn-coming-soon">기간 검색</button>
                    <button class="btn-type1 btn-coming-soon">전체 현황 다운로드</button>
                </span>
            </div>
            <div class="wrap-contents">
                <div class="top">
                    <div class="c-flex-sty01 targetDate-wrap">
                        <span th:text="${searchStartDeStr}"></span>
                        <span>&nbsp;~&nbsp;</span>
                        <span th:text="${searchEndDeStr}"></span>
                    </div>
                </div>
                <div class="contents">
                    <div class="status-card">
                        <div class="card type1">
                            <div class="title-box menu2-1">
                                <div class="card-title">총 서명 완료 수</div>
                                <div class="card-desc">디지털 서명 처리 수</div>
                            </div>
                            <div class="card-content"><span th:text="${fileAnalysisListStatus != null ? #numbers.formatInteger(fileAnalysisListStatus.fileCount, 0, 'COMMA') : 0}" class="size">0</span> <span class="size-unit">건</span></div>
                        </div>
                        <div class="card type1">
                            <div class="title-box menu2-2">
                                <div class="card-title">탐지 수</div>
                                <div class="card-desc">LLM이 탐지한 민감정보 수</div>
                            </div>
                            <div class="card-content"><span th:text="${fileAnalysisListStatus != null ? #numbers.formatInteger(fileAnalysisListStatus.totalDetectionCount, 0, 'COMMA') : 0}" class="size">0</span> <span class="size-unit">건</span></div>
                        </div>
                        <div class="card type1">
                            <div class="title-box menu2-3">
                                <div class="card-title">분석 용량</div>
                                <div class="card-desc">LLM이 분석한 전체 용량</div>
                            </div>
                            <div class="card-content"><span th:text="${fileAnalysisListStatus != null ? fileAnalysisListStatus.formattedTotalFileSize : 0}" class="size">0</span> <span th:text="${fileAnalysisListStatus != null ? fileAnalysisListStatus.formattedTotalFileSizeUnit : 'B'}" class="size-unit">B</span></div>
                        </div>
                        <div class="card type1">
                            <div class="title-box menu2-4">
                                <div class="card-title">다운로드 수</div>
                                <div class="card-desc">서명파일 다운로드 수</div>
                            </div>
                            <div class="card-content"><span th:text="${fileAnalysisListStatus != null ? #numbers.formatInteger(fileAnalysisListStatus.downloadCount, 0, 'COMMA') : 0}" class="size">0</span> <span class="size-unit">건</span></div>
                        </div>
                    </div>
                    <h2 class="type1">디지털 서명 처리 현황</h2>
                    <div class="table-wrap type1">
                        <table class="table-sty01">
                            <caption>
                                디지털 서명 처리 현황
                            </caption>
                            <thead>
                                <tr>
                                    <th>파일명</th>
                                    <th>등록 일시</th>
                                    <th>상태</th>
                                    <th>파일용량</th>
                                    <th>민감정보개수</th>
                                    <th>민감정보등급</th>
                                    <th>다운로드 수</th>
                                    <th>다운로드</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:if="${fileAnalysisListPagination.isEmpty}">
                                    <td colspan="8">데이터가 없습니다.</td>
                                </tr>
                                <tr th:each="fileAnalysis : ${fileAnalysisListPagination.dataList}">
                                    <td th:text="${fileAnalysis.detectionFileName}"></td>
                                    <td th:text="${#temporals.format(fileAnalysis.createDt, 'yyyy-MM-dd HH:mm:ss')}">2025-01-26: 15:00</td>
                                    <td th:text="${fileAnalysis.analysisStatusCcdNm}"></td>
                                    <td><span th:text="${fileAnalysis.formattedTotalFileSize}"></span> <span th:text="${fileAnalysis.formattedTotalFileSizeUnit}"></span></td>
                                    <td th:text="${#numbers.formatInteger(fileAnalysis.totalDetectionCount, 0, 'COMMA')}"></td>
                                    <td th:text="${fileAnalysis.maxDetectionTypeCcdNm}"></td>
                                    <td th:text="${#numbers.formatInteger(fileAnalysis.downloadCount, 0, 'COMMA')}"></td>
                                    <td>
                                        <button th:if="${fileAnalysis.signedFileId}" class="table-btn-sty01 btn-download-signed-file" th:attr="data-signed-file-id=${fileAnalysis.signedFileId}">다운로드</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="pagination-wrapper">
                            <ul th:if="${fileAnalysisListPagination.isNotEmpty}" class="pagination">
                                <li th:if="${fileAnalysisListPagination.firstPageNoOnPageList gt 1}" class="paginate_button prev">
                                    <a href="#" th:onclick="goPage([[${fileAnalysisListPagination.firstPageNoOnPageList - 1}]])">&lt;</a>
                                </li>
                                <th:block th:each="pageNo : ${#numbers.sequence(fileAnalysisListPagination.firstPageNoOnPageList, fileAnalysisListPagination.lastPageNoOnPageList)}">
                                    <li th:if="${pageNo eq fileAnalysisListPagination.pageNo}" class="paginate_button active">
                                        <a href="#" th:text="${pageNo}"></a>
                                    </li>
                                    <li th:if="${pageNo ne fileAnalysisListPagination.pageNo}" class="paginate_button">
                                        <a href="#" th:onclick="goPage([[${pageNo}]])" th:text="${pageNo}"></a>
                                    </li>
                                </th:block>
                                <li th:if="${fileAnalysisListPagination.lastPageNoOnPageList lt fileAnalysisListPagination.lastPageNo}" class="paginate_button next">
                                    <a href="#" th:onclick="goPage([[${fileAnalysisListPagination.lastPageNoOnPageList + 1}]])">&gt;</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </th:block>
</html>
