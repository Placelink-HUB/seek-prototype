<!DOCTYPE html>
<!--
SEEK
Copyright (C) 2025 placelink

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program. If not, see <https://www.gnu.org/licenses/>.

=========================================================================

상업적 이용 또는 AGPL-3.0의 공개 의무를 면제받기
위해서는, placelink로부터 별도의 상업용 라이선스(Commercial License)를 구매해야 합니다.
For commercial use or to obtain an exemption from the AGPL-3.0 license
requirements, please purchase a commercial license from placelink.
*** 문의처: help@placelink.shop (README.md 참조)
-->
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{_layout/basic/layout}">
    <th:block layout:fragment="bodyStyle"></th:block>
    <th:block layout:fragment="bodyScript">
        <script type="module">
            import {S2Util} from '[[@{/public/js/s2.util.js}]]';

            window.initPage = () => {
                {
                    // 에이전트 상태를 주기적으로 조회한다.
                    getAgentStatus();
                    setInterval(function () {
                        getAgentStatus();
                    }, 10_000);
                }
            };

            function getAgentStatus() {
                S2Util.fetch(
                    '[[@{/public/analysis/agent-status-list}]]',
                    {
                        method: 'get',
                        dataType: 'json',
                        hideLoading: true
                    },
                    function (response) {
                        {
                            // PC 에이전트 상태
                            document.getElementById('agentNormalCount').textContent = response.agentStatusListStatus.normalCount;
                            document.getElementById('agentInspectCount').textContent = response.agentStatusListStatus.inspectCount;
                            document.getElementById('agentWarningCount').textContent = response.agentStatusListStatus.warningCount;
                        }

                        {
                            // PC별 데이터 보호 프로세스 작동 현황
                            const agentStatusList = document.querySelector('#agentStatusList');
                            if (!response.agentStatusList || response.agentStatusList.length === 0) {
                                agentStatusList.innerHTML = '<tr><td colspan="10">데이터가 없습니다.</td></tr>';
                            } else {
                                let agentStatusListHTML = '';
                                for (const agentStatus of response.agentStatusList) {
                                    let eventDateTimeStr = '';
                                    if (agentStatus.eventDateTime && Array.isArray(agentStatus.eventDateTime) && agentStatus.eventDateTime.length >= 6) {
                                        eventDateTimeStr = dayjs(new Date(agentStatus.eventDateTime[0], agentStatus.eventDateTime[1] - 1, agentStatus.eventDateTime[2], agentStatus.eventDateTime[3], agentStatus.eventDateTime[4], agentStatus.eventDateTime[5])).format('YYYY-MM-DD HH:mm:ss');
                                    }

                                    agentStatusListHTML += `
                                        <tr>
                                            <td>${agentStatus.clientIp}</td>
                                            <td>${agentStatus.macAddr}</td>
                                            <td>${agentStatus.userId ? agentStatus.userId : '-'}</td>
                                            <td class="agent-status-indicator ${agentStatus.minispySysYn}"></td>
                                            <td class="agent-status-indicator ${agentStatus.mspyUserExeYn}"></td>
                                            <td class="agent-status-indicator ${agentStatus.wfpBlockerExeYn}"></td>
                                            <td class="agent-status-indicator ${agentStatus.clickDomainAgentExeYn}"></td>
                                            <td>${eventDateTimeStr}</td>
                                            <td class="${agentStatus.conditionLevel}">${agentStatus.conditionLevel}</td>
                                            <td>${agentStatus.conditionLevelCcd === 'normal' ? '' : '<button class="table-btn-sty01 btn-coming-soon">전송</button>'}</td>
                                        </tr>
                                    `;
                                }

                                S2Util.replaceChildren(agentStatusList, agentStatusListHTML, {
                                    onNodeReady: (node) => {
                                        node.querySelector('.btn-coming-soon')?.addEventListener('click', () => S2Util.alert('준비 중입니다.'));
                                    }
                                });
                            }
                        }
                    }
                );
            }
        </script>
    </th:block>
    <th:block layout:fragment="bodyFragment">
        <div class="main-contents-contents">
            <div class="wrap-top">
                <h1>
                    <span class="main-title menu5">PC 에이전트 상태</span>
                    <span class="sub-title">동작 중인 에이전트 상태 점검</span>
                </h1>
            </div>
            <div class="wrap-contents">
                <div class="contents">
                    <div class="status-card">
                        <div class="card type1 three-wide mint">
                            <div class="title-box menu5-2">
                                <div class="card-title">정상</div>
                                <div class="card-desc">데이터 보호 프로세스 모두 작동</div>
                            </div>
                            <div class="card-content"><span id="agentNormalCount" class="size">0</span> <span class="size-unit">건</span></div>
                        </div>
                        <div class="card type1 three-wide tangerine">
                            <div class="title-box menu5-3">
                                <div class="card-title">점검</div>
                                <div class="card-desc">일부/전체 프로세스 작동 중지</div>
                            </div>
                            <div class="card-content"><span id="agentInspectCount" class="size">0</span> <span class="size-unit">건</span></div>
                        </div>
                        <div class="card type1 three-wide red">
                            <div class="title-box menu5-4">
                                <div class="card-title">경고</div>
                                <div class="card-desc">시간/패턴 이상 탐지 (업무 시간 중 모든 에이전트 비활성화)</div>
                            </div>
                            <div class="card-content"><span id="agentWarningCount" class="size">0</span> <span class="size-unit">건</span></div>
                        </div>
                    </div>
                    <h2 class="type1">PC별 데이터 보호 프로세스 작동 현황</h2>
                    <div class="table-wrap type1 dark-cyan">
                        <table class="table-sty01">
                            <caption>
                                PC별 데이터 보호 프로세스 작동 현황
                            </caption>
                            <thead>
                                <tr>
                                    <th>IP</th>
                                    <th>Mac 주소</th>
                                    <th>사용자 ID</th>
                                    <th class="c-width-10p">파일 차단 상태</th>
                                    <th class="c-width-10p">SSH/FTP 차단 상태</th>
                                    <th class="c-width-10p">화이트리스트 상태</th>
                                    <th class="c-width-10p">서명 검증 상태</th>
                                    <th>최근 Heartbeat 시각</th>
                                    <th>탐지 결과</th>
                                    <th>알림 전송</th>
                                </tr>
                            </thead>
                            <tbody id="agentStatusList"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </th:block>
</html>
