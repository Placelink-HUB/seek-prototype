<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{_layout/basic/layout}">
<th:block layout:fragment="bodyScript">

    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            initDropZone();

            // 검사항목 선택 시 파일 구분 넣어주고 첨부 파일 초기화
            document.querySelectorAll('.information-box [name=analysisSe]').forEach(selectedItem => {
                selectedItem.addEventListener('click', () => {
                    document.querySelector('.analysis-file-se span').textContent = selectedItem.value === '[[${Constants.CD_ANALYSIS_SE_1010}]]' ? 'miRNA ' : 'Metabolite ';
                    deleteFile();
                });
            })

            // form 항목 선택 시 에러 메시지 초기화
            document.querySelector('.information-box').querySelectorAll('[name=analysisSe], [name=name], [name=birthDe], [name=genderCcd]').forEach(item => {
                item.addEventListener('change', () => {
                    if (item.value) {
                        document.querySelector(`[data-form-error=${item.name}]`).textContent = '';
                    }
                })
            })
        });

        let g_uploadFile = null;

        function initDropZone() {
            g_uploadFile = null;
            const dropZone = document.querySelector('.analysis-file-upload .analysis-file-upload-box');
            const fileUpload = document.querySelector('.analysis-file-upload .analysis-file-upload');

            objDropZone = new coreDropZone(
                $('.analysis-file-upload .analysis-file-upload-box'),
                function () {
                    return '/';
                },
                function (uploadItems) {
                    const file = uploadItems.files[0];
                    g_uploadFile = file;

                    $('.analysis-file-upload .analysis-file-upload-box')
                        .addClass('active').end()
                        .find('.analysis-file-upload-icon').addClass('d-none').end()
                        .find('.analysis-file-upload-ok').removeClass('d-none')
                        .find('.analysis-file-info .file-name').text(file.name);
                }
            );

            if (dropZone) {
                dropZone.addEventListener('dragenter', function () {
                    this.classList.add('highlight');
                });

                dropZone.addEventListener('dragover', function (e) {
                    e.preventDefault();
                    this.classList.add('highlight');
                });

                dropZone.addEventListener('dragleave', function () {
                    this.classList.remove('highlight');
                });

                dropZone.addEventListener('drop', function (e) {
                    e.preventDefault();
                    this.classList.remove('highlight');
                });

                const ceUpload = dropZone.querySelector('.analysis-file-upload-button');
                if (ceUpload) {
                    ceUpload.addEventListener('click', function (e) {
                        fileUpload.click();
                    });
                }
            }

            if (fileUpload) {
                fileUpload.addEventListener('change', function (e) {
                    inputFileUpload(this);
                });
            }
        }

        function inputFileUpload(obj) {
            const filePath = '/';
            for (let i = 0; i < obj.files.length; i++) {
                const file = obj.files[i];
                file.filePath = filePath;
                if (file.filePath !== '/') {
                    file.fullPath = file.filePath + '/' + file.name;
                } else {
                    file.fullPath = file.filePath + file.name;
                }

                g_uploadFile = file;
                $('.analysis-file-upload .analysis-file-upload-box')
                    .addClass('active').end()
                    .find('.analysis-file-upload-icon').addClass('d-none').end()
                    .find('.analysis-file-upload-ok').removeClass('d-none').end()
                    .find('.analysis-file-info .file-name').text(file.name);

                // 파일 선택 시 에러 메시지 초기화
                document.querySelector(`[data-form-error=uploadFile]`).textContent = '';
            }
        }

        function deleteFile() {
            g_uploadFile = '';
            $('.analysis-file-upload .analysis-file-upload-box')
                .removeClass('active').end()
                .find('.analysis-file-upload-icon').removeClass('d-none').end()
                .find('.analysis-file-upload-ok').addClass('d-none')
                .find('.analysis-file-info .file-name').text('');
        }

        function createAnalysis() {
            if (!S2Util.s2validate('.information-box') || !g_uploadFile) {
                if (!g_uploadFile) {

                    document.querySelector('[data-form-error="uploadFile"]').textContent = `${document.querySelector('.analysis-file-se span').textContent} 파일 첨부는 필수 항목 입니다.`
                }
                return;
            }

            const personalInfoArea = document.querySelector('.information-box');
            const fAnalysisSe = personalInfoArea.querySelector('[name=analysisSe]:checked');
            const fParticipantsId = personalInfoArea.querySelector('[name=participantsId]');
            const fName = personalInfoArea.querySelector('[name=specimen_collection_de]');
            const fName = personalInfoArea.querySelector('[name=name]');
            const fBirthDe = personalInfoArea.querySelector('[name=birthDe]');
            const fGenderCcd = personalInfoArea.querySelector('[name=genderCcd]:checked');
            const fMobileNumber = personalInfoArea.querySelector('[name=mobileNumber]');
            const fPostCode = personalInfoArea.querySelector('[name=postCode]');
            const fAddress = personalInfoArea.querySelector('[name=address]');
            const fAddressDetail = personalInfoArea.querySelector('[name=addressDetail]');

            S2Util.fetch(`/api/analysis/request/${fAnalysisSe.value}`, {
                method: 'post',
                dataType: 'multipart/form-data',
                participantsId: fParticipantsId.value,
                name: fName.value,
                birthDe: fBirthDe.value,
                genderCcd: fGenderCcd.value,
                mobileNumber: fMobileNumber.value,
                postCode: fPostCode.value,
                address: fAddress.value,
                addressDetail: fAddressDetail.value,
                file: g_uploadFile
            }, function () {
                fAnalysisSe.checked = false;
                fParticipantsId.value = '';
                fName.value = '';
                fBirthDe.value = '';
                fGenderCcd.checked = false;
                fMobileNumber.value = '';
                fPostCode.value = '';
                fAddress.value = '';
                fAddressDetail.value = '';

                deleteFile();
                S2Util.showToast('분석 요청이 등록되었습니다.');
            });
        }

        function execDaumPostcode() {
            new daum.Postcode({
                oncomplete: function(data) {
                    document.querySelector('.information-box [name=address]').value = data.address + (data.buildingName ? `, ${data.buildingName}` : '');
                    document.querySelector('.information-box [name=postCode]').value = data.zonecode;
                }
            }).open();
        }

    </script>
</th:block>
<th:block layout:fragment="bodyFragment">
    <div class="analysis-file-upload">
        <h2 class="request-form-title">검사자 정보</h2>
        <div class="information-box">
            <div class="row">
                <span class="title">검사항목 <span class="c-red">*</span></span>
                <label for="analysisSe_1010" class="c-pointer">Tissue</label>
                <input type="radio" id="analysisSe_1010" name="analysisSe" value="1010" title="검사항목" required>
                <label for="analysisSe_1020" class="c-pointer">Blood</label>
                <input type="radio" id="analysisSe_1020" name="analysisSe" value="1020">
                <label for="analysisSe_2010" class="c-pointer">Autism</label>
                <input type="radio" id="analysisSe_2010" name="analysisSe" value="2010">
                <span data-form-error="analysisSe"></span>
            </div>
            <div class="row">
                <label class="title" for="specimenCollectionDe">검체 체취 일자 <span class="c-red">*</span></label>
                <input type="text" id="specimenCollectionDe" name="specimenCollectionDe" class="datepicker" title="검체 체취 일자" required>
                <span data-form-error="specimenCollectionDe"></span>
            </div>
            <div class="row">
                <input type="hidden" name="participantsId">
                <label class="title" for="username">이름 <span class="c-red">*</span></label>
                <input type="text" id="username" name="name" title="이름" required>
                <span data-form-error="name"></span>
            </div>
            <div class="row">
                <label class="title" for="birthDe">생년월일 <span class="c-red">*</span></label>
                <input type="text" id="birthDe" name="birthDe" class="datepicker" title="생년월일" required>
                <span data-form-error="birthDe"></span>
            </div>
            <div class="row">
                <span class="title">성별 <span class="c-red">*</span></span>
                <label for="genderCcd_M" class="c-pointer">남성</label>
                <input type="radio" id="genderCcd_M" name="genderCcd" value="M" title="성별" required>
                <label for="genderCcd_F" class="c-pointer">여성</label>
                <input type="radio" id="genderCcd_F" name="genderCcd" value="F">
                <span data-form-error="genderCcd"></span>
            </div>
            <div class="row">
                <label class="title" for="mobileNumber">연락처</label>
                <input type="text" id="mobileNumber" name="mobileNumber">
            </div>
            <div class="row">
                <label class="title" for="address">주소</label>
                <input type="text" id="address" name="address" onclick="execDaumPostcode()" placeholder="주소 검색" readonly="readonly">
                <label for="addressDetail" class="d-none">상세 주소</label>
                <input type="text" id="addressDetail" name="addressDetail" placeholder="상세 주소">
                <input type="hidden" name="postCode">
            </div>
        </div>
        <h2 class="request-form-title analysis-file-se inline-block"><span></span>파일 첨부</h2>
        <span data-form-error="uploadFile"></span>
        <div class="analysis-file-upload-box">
            <input type="file" class="analysis-file-upload d-none"/>
            <div class="analysis-file-upload-icon">
                <img src="/public/images/파일아이콘-01.png" alt="파일아이콘"/>
            </div>
            <div class="analysis-file-upload-ok d-none">
                <div class="analysis-file-upload-ok-wrap">
                    <img class="checked-file" src="/public/images/icon_file_chk.png" alt="파일선택완료"/>
                    <div class="analysis-file-info flex-sty01">
                        <div class="flex-sty02">
                            <img class="analysis-file-icon" src="/public/images/icon_file_ok.png" alt="파일아이콘"/>
                            <div class="analysis-file-border"></div>
                            <div class="analysis-file-title file-name"></div>
                        </div>
                        <div class="analysis-file-remove">
                            <a onclick="deleteFile();"><img src="/public/images/icon_remove.png" alt="삭제아이콘"/></a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="analysis-file-upload-text">
                <p>첨부할 파일을 여기에 끌어다 놓거나, 파일 선택 버튼을 직접 선택해주세요.</p>
            </div>
            <button class="analysis-file-upload-button">
                <img src="/public/images/업로드아이콘-01.png" alt="파일선택" style="height: 21px; width: auto;"/>
                <span>파일선택</span>
            </button>
        </div>
        <button class="file-analyzing-button" onclick="createAnalysis();">분석하기</button>
    </div>
</th:block>
</html>
